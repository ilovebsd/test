package bizportal.nasacti.emsivr;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import bizportal.nasacti.ipivr.action.CommandAction;
import bizportal.nasacti.ipivr.common.IpivrConfig;
import bizportal.nasacti.ipivr.dao.ResponseTimeDAO;
import bizportal.nasacti.ipivr.dto.ScheduleDTO;
import bizportal.nasacti.ipivr.dto.ResponseTimeDTO;

public class EmsResponseTimeManageInputAction implements CommandAction {
	/**
	 * requestProc
	 *
	 * @param request HttpServletRequest
	 * @param response HttpServletResponse
	 * @param ipivrConfig IpivrConfig
	 * @return String
	 * @throws Throwable
	 * @todo Implement this bizportal.nasacti.ipivr.action.CommandAction
	 *   method
	 */
	public String requestProc(HttpServletRequest request,
							  HttpServletResponse response,
							  IpivrConfig ipivrConfig) throws Throwable {
		request.setCharacterEncoding("euc-kr");
		int iRtn = -1;
		int insertCnt = 0;
		int idx = 0;

		String strAmModeName = request.getParameter("amModeName").trim(); // 응답스케줄 명
		String strAmMemo = request.getParameter("amMemo").trim(); // 응답 스케줄 설명
		String tdHidden1[] = request.getParameterValues("tdHidden1");				//시간(시)
		String tdHidden2[] = request.getParameterValues("tdHidden2");				//시간(분)
		String tdHidden3[] = request.getParameterValues("tdHidden3");				//응답모드명
		String tdHidden4[] = request.getParameterValues("tdHidden4");				//인덱스(scCode)
		String tdHidden5[] = request.getParameterValues("tdHidden5");				//추가(I),수정(E),삭제(D), 최초로딩되었으며 변경 사항 없음(O)

		for(int i=0; i < tdHidden5.length; i++)
			if(tdHidden5[i].equals("I") || tdHidden5[i].equals("E"))
				insertCnt += 1;

		ScheduleDTO[] aScheduleDTO = new ScheduleDTO[insertCnt];

		for(int i=0; i < tdHidden5.length; i++) {
			if(tdHidden5[i].equals("I") || tdHidden5[i].equals("E")) {
				aScheduleDTO[idx] = new ScheduleDTO();
				aScheduleDTO[idx].setAtStartTime(tdHidden1[i] + ":" + tdHidden2[i]);
				aScheduleDTO[idx].setAtScName(tdHidden3[i]);
				aScheduleDTO[idx].setAtScode(tdHidden4[i]);
				idx += 1;
		    }
		}

		ResponseTimeDTO responseTimeDTO = new ResponseTimeDTO();
		responseTimeDTO.setAmModeName(strAmModeName);
		responseTimeDTO.setAmMemo(strAmMemo);

		ResponseTimeDAO responseTime = ResponseTimeDAO.getInstance();

		iRtn = responseTime.insertResponseTime(responseTimeDTO, aScheduleDTO);


	switch(iRtn) {
		case 1:
			//request.setAttribute("msg", "추가되었습니다.");
			break;
		case 2:
			request.setAttribute("msg", "응답스케줄 이름이 중복되었습니다.");
			break;
		case -1:
			request.setAttribute("msg", "등록에러가 발생하였습니다.");
			break;
	}



		return "./emsResponseTimeManageListForm.do2";
	}
}
