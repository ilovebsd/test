package bizportal.nasacti.emsivr;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import bizportal.nasacti.ipivr.action.CommandAction;
import bizportal.nasacti.ipivr.common.IpivrConfig;
import com.oreilly.servlet.MultipartRequest;
import com.oreilly.servlet.multipart.DefaultFileRenamePolicy;
import bizportal.nasacti.ipivr.common.FileNameChecker;
import bizportal.nasacti.ipivr.dao.VoiceDAO;
import bizportal.nasacti.ipivr.dto.VoiceDTO;
import bizportal.nasacti.ipivr.common.FileUtil;

public class EmsVoiceFileManageInputAction implements CommandAction {
	/**
	 * requestProc
	 *
	 * @param request HttpServletRequest
	 * @param response HttpServletResponse
	 * @param ipivrConfig IpivrConfig
	 * @return String
	 * @throws Throwable
	 * @todo Implement this bizportal.nasacti.ipivr.action.CommandAction
	 *   method
	 */
	public String requestProc(HttpServletRequest request,
							  HttpServletResponse response,
							  IpivrConfig ipivrConfig) throws Throwable {
		request.setCharacterEncoding("euc-kr");
		int iRtn = -1;
		boolean bValidFileName = false;
		String strSaveFolder = ipivrConfig.strRealPath + "/../ipcs_files/fileupwav";
		int maxSize = ipivrConfig.maxUploadSize * 1024 * 1024;  // 10 MB

		MultipartRequest multi = null;
		multi = new MultipartRequest(request, strSaveFolder, maxSize, "euc-kr", new DefaultFileRenamePolicy());

		String strWName = multi.getParameter("wName");
		String strOriginalFileName = multi.getOriginalFileName("wFile");
		String strSavedFileName = multi.getFilesystemName("wFile");

		if(strOriginalFileName == null)
			strOriginalFileName = "";

		bValidFileName = FileNameChecker.isValidFileName(strOriginalFileName);

		VoiceDAO voiceDAO = VoiceDAO.getInstance();
		VoiceDTO voiceDTO = new VoiceDTO();

		voiceDTO.setWName(strWName);
		voiceDTO.setWFile(strOriginalFileName);
		voiceDTO.setWDiv("U");

		if(bValidFileName == true) {
			iRtn = voiceDAO.insertVoice(voiceDTO);

			switch(iRtn) {
				case 1:
					//request.setAttribute("msg", "추가되었습니다.");
					break;
				case 2:
					if(!strOriginalFileName.equals(""))
						FileUtil.delete(strSaveFolder + "/" + strSavedFileName);
					request.setAttribute("msg", "이미 등록된 파일이름입니다. 파일명을 변경해서 올려주세요.");
					break;
				case -1:
					if(!strOriginalFileName.equals(""))
						FileUtil.delete(strSaveFolder + "/" + strSavedFileName);
					request.setAttribute("msg", "등록에러가 발생하였습니다.");
					break;
			}
		} else {
			if(!strOriginalFileName.equals(""))
				FileUtil.delete(strSaveFolder + "/" + strSavedFileName);
			request.setAttribute("msg", "파일명에 허용되지 않는 문자가 있습니다.");
		}
		return "./emsVoiceFileManageListForm.do2";

	}
}
