package com.acromate.dao.system;

import java.sql.ResultSet;
import java.util.ArrayList;

import acromate.ConnectionManager;

import com.acromate.driver.db.DataStatement;
import com.acromate.dto.system.IoiTraceDTO;
import com.acromate.util.Str;

public class IoiTraceDAO {
	
    public IoiTraceDAO() {}
    
    public ArrayList getList(DataStatement statement, String keyno, String time) {
        String queryString = "" ;
        String strWhere = "";
        ArrayList list = new ArrayList() ;
        ResultSet rs = null ;
        IoiTraceDTO ioiTraceDTO ;

        try {
//        	queryString = " SELECT  " + statement.getToChar("STARTTIME","YYYY-MM-DD HH24:MI:SS") + " AS STARTTIME_EX, ";
//        	queryString +=" CALLERE164, CALLEEE164,CALLERENDPOINTID, CALLEEENDPOINTID, IOIID";
//        	queryString +=" FROM Table_IoiTrace ";
//        	queryString += strWhere ;
//        	queryString +=" ORDER BY STARTTIME desc";
            strWhere = " ";
            strWhere += " call.StartTime >= SYSDATE-"+0.0007*Integer.valueOf(time);
            strWhere += " AND (call.CALLERE164 like '" + keyno + "%' ";
            strWhere += " OR call.CALLEEE164 like '" + keyno + "%') ";
            
        	queryString =  " SELECT  " + statement.getToChar("call2.STARTTIME","YYYY-MM-DD HH24:MI:SS") + " STARTTIME_EX, " ;
        	queryString += " call2.CALLERE164, call2.CALLEEE164,call2.CALLERENDPOINTID, call2.CALLEEENDPOINTID, callioi.IOIID FROM" ;
        	queryString += " (SELECT ioi.IOIID,ioi.callid From  Table_CallTrace call " ;
        	queryString += " Join Table_IOITrace ioi On "+ strWhere  +"  and ioi.callid = call.callid) callioi " ;
        	queryString += " Join Table_CallTrace call2 On callioi.callid = call2.callid " ;
        	queryString +=" ORDER BY call2.STARTTIME desc";
            System.out.println(queryString);
            rs = statement.executeQuery(queryString) ;
            while ( rs.next() )  {
            	ioiTraceDTO = new IoiTraceDTO() ;
            	ioiTraceDTO.setStartTime(Str.CheckNullString(rs.getString("STARTTIME_EX")).trim()); // STARTTIME
            	ioiTraceDTO.setCallerE164(Str.CheckNullString(rs.getString("CALLERE164")).trim());  // SYSGROUPNAME
            	ioiTraceDTO.setCalleeE164(Str.CheckNullString(rs.getString("CALLEEE164")).trim()); // CALLERE164
            	ioiTraceDTO.setCallerEndpointID(Str.CheckNullString(rs.getString("CALLERENDPOINTID")).trim());  // SYSGROUPNAME
            	ioiTraceDTO.setCalleeEndpointID(Str.CheckNullString(rs.getString("CALLEEENDPOINTID")).trim()); // CALLERE164
            	ioiTraceDTO.setIoiID(Str.CheckNullString(rs.getString("IOIID")).trim()); // CALLEEE164

                list.add(ioiTraceDTO) ;
            }
        } catch(Exception e) {
            e.printStackTrace() ;
        } finally {
            try {  
            	if (rs != null) rs.close();  
        	} catch(Exception e) { e.printStackTrace(); }
        }
        return list ;
    }
}
