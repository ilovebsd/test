package command;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;
import acromate.common.util.WebUtil;
import acromate.ConnectionManager;
import acromate.common.StaticString;
import com.acromate.driver.db.DataStatement;
import com.acromate.util.Str;
import waf.BaseEntity;
import waf.SessionManager;
import webuser.ServerLogin;
import dto.system.SIPRegServerDTO;
import dto.system.SystemConfigDTO;
import system.SystemConfigFileMake;
import framework.url.Urldownload;
import dao.system.CommonDAO;
import java.util.ArrayList;
import java.util.HashMap;
		
public class SystemFileSaveCommand implements Command {
	private int nEmergency;
	public String execute(HttpServletRequest req, HttpServletResponse res) {
//		DataStatement 	stmt 			= null;
		String 			forwardingPage 	= "";				
		String 			resStr 			= "";

		// 서버로부터 DataStatement 객체를 할당
//		DataStatement 	stmt 		=	ConnectionManager.allocStatement("SSW");

		try {
			String 	wanName		= new String(Str.CheckNullString(req.getParameter("hiWanName")).getBytes("8859_1"), "euc-kr");		// prefix 종류 
			String 	lanName 	= new String(Str.CheckNullString(req.getParameter("hiLanName")).getBytes("8859_1"), "euc-kr");		// 시작 prefix
//			String 	selectWan	= new String(Str.CheckNullString(req.getParameter("hiSelectWan")).getBytes("8859_1"), "euc-kr");	// 1 : 유동 IP, 2 : 고정 IP
			String 	wanId 		= new String(Str.CheckNullString(req.getParameter("hiWanId")).getBytes("8859_1"), "euc-kr");		// 가입자 Id
			String 	wanIp 		= new String(Str.CheckNullString(req.getParameter("hiWanIp")).getBytes("8859_1"), "euc-kr");		// 외부 IP			
			String 	oldWanIp	= new String(Str.CheckNullString(req.getParameter("hiOldWanIp")).getBytes("8859_1"), "euc-kr");		// 변경전 외부 IP
			String 	wanMask 	= new String(Str.CheckNullString(req.getParameter("hiWanMask")).getBytes("8859_1"), "euc-kr");		// 외부 서브넷마스크
			String 	wanGateway 	= new String(Str.CheckNullString(req.getParameter("hiWanGateway")).getBytes("8859_1"), "euc-kr");	// 게이트웨이
			String 	wanMac 		= new String(Str.CheckNullString(req.getParameter("hiWanMac")).getBytes("8859_1"), "euc-kr");		// 외부 Mac 
			String 	wanDns 		= new String(Str.CheckNullString(req.getParameter("hiWanDns")).getBytes("8859_1"), "euc-kr");		// 외부 Dns
			String 	selectLan	= new String(Str.CheckNullString(req.getParameter("hiSelectLan")).getBytes("8859_1"), "euc-kr");	// 1 : DHCP 사용함, 2 : DHCP 사용안함
			String 	lanIp 		= new String(Str.CheckNullString(req.getParameter("hiLanIp")).getBytes("8859_1"), "euc-kr");		// 내부 IP
			String 	oldLanIp 	= new String(Str.CheckNullString(req.getParameter("hiOldLanIp")).getBytes("8859_1"), "euc-kr");		// 변경전 내부 IP
			String 	startIp 	= new String(Str.CheckNullString(req.getParameter("hiStartIp")).getBytes("8859_1"), "euc-kr");		// 시작IP
			String 	endIp 		= new String(Str.CheckNullString(req.getParameter("hiEndIp")).getBytes("8859_1"), "euc-kr");		// 종료IP
			String 	timeTemp 	= new String(Str.CheckNullString(req.getParameter("hiTimeTemp")).getBytes("8859_1"), "euc-kr");		// 갱신주기
			String 	lanMask 	= new String(Str.CheckNullString(req.getParameter("hiLanMask")).getBytes("8859_1"), "euc-kr");		// 내부 서브넷마스크
			String 	lanDns 		= new String(Str.CheckNullString(req.getParameter("hiLanDns")).getBytes("8859_1"), "euc-kr");		// 내부 Dns			
			int		ipCycle		= Integer.parseInt(timeTemp)*8640;																	// IP 갱신주기
						
			String 	readWanIp	= new String(Str.CheckNullString(req.getParameter("hiReadWanIp")).getBytes("8859_1"), "euc-kr");	// 파일에서 읽은 외부 IP
			String 	strDomain 	= new String(Str.CheckNullString(req.getParameter("hiDomainid")).getBytes("8859_1"), "euc-kr");		// 도메인
			int		domainCheck = 0;
			
			System.out.println("DB 도메인 : "+strDomain);
			System.out.println("입력한 도메인 : "+wanId);
			System.out.println("내부 DHCP 사용 유무 1 : "+selectLan);
			
			// 서버로부터 DataStatement 객체를 할당
			DataStatement 	stmt 		=	ConnectionManager.allocStatement("SSW");
			
			if("".equals(strDomain)&&!"".equals(wanId)){
				// 최초 사용자ID 저장하는 경우
				CommonDAO	commonDao		=	new CommonDAO();
				String commonSql			=	"select keyname,valueinfo from table_updateenv where envname='ddnsserver'";
				String strColNames[]		=	{"keyname","valueinfo"};
				ArrayList envList			=	commonDao.select(stmt,commonSql,strColNames);
				String updateServerip="203.242.63.62";
				if(envList!=null && envList.size()!=0){
					for(int i=0;i<envList.size();i++){
						HashMap temp	=	(HashMap)envList.get(i);
						if(temp!=null){
							String tempurl	=	(String)temp.get("valueinfo");
							if(tempurl != null)	updateServerip=tempurl;
						}
					}
				}
				//할당받은 DataStatement 객체는 반납
				if (stmt != null ) ConnectionManager.freeStatement(stmt);				
				
				Urldownload	urldwn			=	new Urldownload();
				String verTmp				=	urldwn.toString("http://"+updateServerip+"/sems/domainCheck.jsp?hiDomain="+wanId+".callbox.kt.com");				
				String verInfo = verTmp.trim();
				//System.out.println("도메인 중복체크 했음...: "+verInfo);
				
				if("OK".equals(verInfo)){
					// 사용가능한 도메인
					//resStr = "systemConfigSet.jsp";
					resStr = "systemConfigSet.jsp";
					
					SystemConfigDTO dto = new SystemConfigDTO();
					dto.setWanName(wanName);
					dto.setLanName(lanName);
					dto.setWanId(wanId);
					dto.setWanIp(wanIp);
					dto.setOldWanIp(oldWanIp);
					dto.setWanMask(wanMask);
					dto.setWanGateway(wanGateway);
					dto.setWanMac(wanMac);
					dto.setWanDns(wanDns);
					dto.setSelectLan(selectLan);
					dto.setLanIp(lanIp);
					dto.setOldLanIp(oldLanIp);
					dto.setStartIp(startIp);
					dto.setEndIp(endIp);
					dto.setTimeCycle(Integer.toString(ipCycle));
					dto.setLanMask(lanMask);
					dto.setLanDns(lanDns);
					dto.setReadWanIp(readWanIp);
					
					SystemConfigFileMake makeFile = new SystemConfigFileMake();
					int insertResult = makeFile.makeFile(dto);
					
					if(insertResult==1){
						resStr = "systemConfigSet.jsp?hiDomainChk=yes2";
						res.sendRedirect("/bizportal/system/"+resStr);
					}else{
						res.sendRedirect("/bizportal/errorMessage.jsp");
					}
				}else if("NO".equals(verInfo)){
					// 이미 사용중인 도메인
					resStr = "systemConfigSet.jsp?hiDomainChk=no";
					res.sendRedirect("/bizportal/system/"+resStr);
				}else{
					// 네트웍크 장애
					resStr = "systemConfigSet.jsp?hiDomainChk=error";
					res.sendRedirect("/bizportal/system/"+resStr);				
				}
			}else{
				// 이미 사용자ID가 저장되어 있는 경우
				resStr = "systemConfigSet.jsp";
				
				SystemConfigDTO dto = new SystemConfigDTO();
				dto.setWanName(wanName);
				dto.setLanName(lanName);
				dto.setWanId(wanId);
				dto.setWanIp(wanIp);
				dto.setOldWanIp(oldWanIp);
				dto.setWanMask(wanMask);
				dto.setWanGateway(wanGateway);
				dto.setWanMac(wanMac);
				dto.setWanDns(wanDns);
				dto.setSelectLan(selectLan);
				dto.setLanIp(lanIp);
				dto.setOldLanIp(oldLanIp);
				dto.setStartIp(startIp);
				dto.setEndIp(endIp);
				dto.setTimeCycle(Integer.toString(ipCycle));
				dto.setLanMask(lanMask);
				dto.setLanDns(lanDns);
				dto.setReadWanIp(readWanIp);
				
				SystemConfigFileMake makeFile = new SystemConfigFileMake();
				int insertResult = makeFile.makeFile(dto);
				
				if(insertResult==1){
					resStr = "systemConfigSet.jsp?hiDomainChk=success";
					res.sendRedirect("/bizportal/system/"+resStr);
				}else{
					res.sendRedirect("/bizportal/errorMessage.jsp");
				}
			}
		} catch (Exception e) {
			try{
				res.sendRedirect("/bizportal/errorMessage.jsp");
			} catch (Exception ee) {
			}
			e.printStackTrace();
		} finally {
			//할당받은 DataStatement 객체는 반납
//			if (stmt != null ) ConnectionManager.freeStatement(stmt);
		}		
		return forwardingPage;
	}
	
	
}
