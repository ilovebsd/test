package command;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;
import acromate.common.util.WebUtil;
import acromate.ConnectionManager;
import acromate.common.StaticString;
import com.acromate.driver.db.DataStatement;
import com.acromate.util.Str;
import waf.BaseEntity;
import waf.SessionManager;
import webuser.ServerLogin;
import dto.system.SIPRegServerDTO;
import dto.system.SystemConfigDTO;
import system.SystemConfigFileMake;
import framework.url.Urldownload;
import dao.system.CommonDAO;
import java.util.ArrayList;
import java.util.HashMap;
		
public class DomainCheckCommand implements Command {
	private int nEmergency;
	public String execute(HttpServletRequest req, HttpServletResponse res) {
//		DataStatement 	stmt 			= null;
		String 			forwardingPage 	= "";				
		String 			resStr 			= "";

		try {
			String 	wanId 		= new String(Str.CheckNullString(req.getParameter("hiWanId")).getBytes("8859_1"), "euc-kr");		// 가입자 Id
			String 	wanIp 		= new String(Str.CheckNullString(req.getParameter("hiWanIp")).getBytes("8859_1"), "euc-kr");		// WanIp
			int		domainCheck = 0;
			
			// 서버로부터 DataStatement 객체를 할당
			DataStatement 	stmt 		=	ConnectionManager.allocStatement("SSW");
			
			// 최초 사용자ID 저장하는 경우
			CommonDAO	commonDao		=	new CommonDAO();
			String commonSql			=	"select keyname,valueinfo from table_updateenv where envname='ddnsserver'";
			String strColNames[]		=	{"keyname","valueinfo"};
			ArrayList envList			=	commonDao.select(stmt,commonSql,strColNames);
			String updateServerip="203.242.63.62";
			if(envList!=null && envList.size()!=0){
				for(int i=0;i<envList.size();i++){
					HashMap temp	=	(HashMap)envList.get(i);
					if(temp!=null){
						String tempurl	=	(String)temp.get("valueinfo");
						if(tempurl != null)	updateServerip=tempurl;
					}
				}
			}
			//할당받은 DataStatement 객체는 반납
			if (stmt != null ) ConnectionManager.freeStatement(stmt);				
			
			Urldownload	urldwn			=	new Urldownload();
			String verTmp				=	urldwn.toString("http://"+updateServerip+"/sems/domainCheck.jsp?hiDomain="+wanId+".callbox.kt.com");				
			String verInfo = verTmp.trim();
			
			System.out.println("################### User ID Duplication Check URL --> " +"http://"+updateServerip+"/sems/domainCheck.jsp?hiDomain="+wanId+".callbox.kt.com" );
			System.out.println("################### User ID Duplication Check Result --> " +verInfo );
			
			if("OK".equals(verInfo)){
				// 사용가능한 도메인
				//resStr = "systemConfigSet.jsp";
				resStr = "systemConfigSet.jsp";
				
				SystemConfigDTO dto = new SystemConfigDTO();
				dto.setWanId(wanId);
				dto.setWanIp(wanIp);
				
				SystemConfigFileMake makeFile = new SystemConfigFileMake();
				int insertResult = makeFile.makeDomain(dto);
				
				if(insertResult==1){
					resStr = "systemConfigSet.jsp?hiDomainChk=yes";
					res.sendRedirect("/bizportal/system/"+resStr);
				}else{
					res.sendRedirect("/bizportal/errorMessage.jsp");
				}
			}else if("NO".equals(verInfo)){
				// 이미 사용중인 도메인
				resStr = "systemConfigSet.jsp?hiDomainChk=no";
				res.sendRedirect("/bizportal/system/"+resStr);
			}else{
				// 네트웍크 장애
				resStr = "systemConfigSet.jsp?hiDomainChk=error";
				res.sendRedirect("/bizportal/system/"+resStr);				
			}
				
		} catch (Exception e) {
			try{
				res.sendRedirect("/bizportal/errorMessage.jsp");
			} catch (Exception ee) {
			}
			e.printStackTrace();
		} finally {
			//할당받은 DataStatement 객체는 반납
//			if (stmt != null ) ConnectionManager.freeStatement(stmt);
		}		
		return forwardingPage;
	}
	
	
}
